<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>
    <script th:inline="javascript">const magic_data = [[${magic_data}]];</script>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/elems.css">
    <link rel="icon" href="/img/duck.png">
</head>
<body>
<div id="app">
    <app-header></app-header>
    <app-form :results="results"></app-form>
    <app-footer></app-footer>
</div>

<template id="header-template">
    <div class="block" id="names">
        <h3>Лабораторная работа № 4</h3> <br/> <span class="left_meta"> Вариант: 18160 </span>
        <span class="right_meta"> Выполнили: Баталов Е. В. и</span> <br/>
        <span class="right_meta"> Прилуцкая Т. И. </span> <br/>
        <span class="left_meta"> Группа: P3201</span>
    </div>
</template>


<template id="footer-template">
    <div class="block">
        <footer class="block">
            <p>
                <a href="http://en.ifmo.ru/en/">
                    <img src="/img/itmo.png" width="120" height="60" border="0"/>
                </a>
            </p>
        </footer>
    </div>
</template>

<template id="form-template">
    <div id="container">
        <form class="block" method="post" action="/logout">
            <input type="submit" value="Выйти" align="center"/>
        </form>
        <div id="canvas_area">
            <canvas id="canvas" width=window.innerWidth/2 height=window.innerHeight/2 @click="eventCanvas">
                Sorry, canvas not supported
            </canvas>
        </div>
        <div id="form_area" class="block">
            <form id="main_form" name="main_form" @submit.prevent="validate">
                <fieldset class="param_field">
                    <legend>Х</legend>
                    <select id="x_input" name="x_input" required="true" v-model="x">
                        <option value="2" selected>2</option>
                        <option value="1.5">1.5</option>
                        <option value="1">1</option>
                        <option value="0.5">0.5</option>
                        <option value="0" >0</option>
                        <option value="-0.5">-0.5</option>
                        <option value="-1">-1</option>
                        <option value="-1.5">-1.5</option>
                        <option value="-2">-2</option>
                    </select>
                </fieldset>
                <fieldset class="param_field">
                    <legend>Y</legend>
                    <input type="text" id="y_input" class="text" name="y_input" placeholder="Y є (-5; 5)"
                           maxlength="10"
                           v-model="y"
                           @click="errorMessageY=''"
                    />
                    <span class="invalid_input_message">{{errorMessageY}}</span>
                </fieldset>
                <fieldset class="param_field">
                    <legend>R</legend>
                    <select id="r_input" name="r_input"@change="this.redraw" v-model="r" @click="errorMessageR=''">
                        <option value="2" selected>2</option>
                        <option value="1.5">1.5</option>
                        <option value="1">1</option>
                        <option value="0.5">0.5</option>
                        <option value="0" selected>0</option>
                        <option value="-0.5">-0.5</option>
                        <option value="-1">-1</option>
                        <option value="-1.5">-1.5</option>
                        <option value="-2">-2</option>
                    </select>
                    <span class="invalid_input_message">{{errorMessageR}}</span>
                </fieldset>
                <input type="submit" id="submitButton" value="Проверить"/>
            </form>
        </div>


        <div id="table_area">
            <table id="history_table">
                <tr>
                    <th>Координата X</th>
                    <th>Координата Y</th>
                    <th>Радиус</th>
                    <th>Результат</th>
                </tr>
                <tr v-for="result in showResults">
                    <td class="x_coord">
                        {{result.x}}
                    </td>
                    <td class="y_coord">
                        {{result.y}}
                    </td>
                    <td>
                        {{result.r}}
                    </td>
                    <td class="result">
                        {{result.isInArea == true ? "попал" : "не попал"}}
                    </td>
                </tr>
            </table>
        </div>
    </div>
</template>

<script>
    const api = Vue.resource('/result');
    Vue.component('app-header', {
        template: '#header-template'
    });

    Vue.component('app-footer', {
        template: '#footer-template'
    });
    Vue.component('app-form', {
        props: ['results'],
        template: '#form-template',
        data: function () {
            return {
                x: 0,
                y: 0,
                r: 2,
                errorMessageR: '',
                errorMessageY: '',
                updateCanvas: false,
                windowWidth: window.innerWidth,
                cc:0.5
            }
        },
        methods: {
            validate: function () {
                let yValue = this.y;
                const min_y = -5;
                const max_y = 5;
                if (this.r < 0) this.errorMessageR = 'поч r <' + 0;
                else this.errorMessageR = '';
                if (yValue === '') {
                    this.errorMessageY = 'Где Y ?';
                } else if (isNaN(Number(yValue))) {
                    this.errorMessageY = 'Это не число';

                } else if (yValue >= max_y || yValue <= min_y) {
                    this.errorMessageY = ' ' + yValue + ' \u{2209} (' + min_y + ' ; ' + max_y + ') !';
                } else {
                    this.errorMessageY = '';
                }

                if (this.errorMessageY === '' && this.errorMessageR === '') this.check();
            },
            check: function () {
                    let result = {
                        x: +Number(this.x).toFixed(3),
                        y: +Number(this.y).toFixed(3),
                        r: +Number(this.r).toFixed(3),
                        isInArea: true
                    };
                    api.save({}, result).then(response =>
                        response.json().then(result => {
                            this.results.push(result);
                        })
                    )

            },
            eventCanvas: function (e) {
                let canvas = document.getElementById("canvas");
                let ctx = canvas.getContext("2d");
                let w = canvas.width;
                let h = canvas.height;
                let r = this.r;
                let coo = this.getMouseCoords(e);
                let x = coo.x;
                let y = coo.y;
                if (r < 0) {
                    this.redraw();
                    ctx.fillStyle = "red";
                    ctx.textAlign = "center";
                    ctx.fillText("КАВО?", w / 4, h / 4);
                    ctx.fill();

                } else if(x>=-2 && x<=2 && y> -5 && y<=5 && r>=0 && r<=2){
                    this.x = x;
                    this.y = y;
                    this.check();

                }},
            draw_plot: function () {
                let canvas = document.getElementById('canvas');
                // canvas.width = window.innerWidth * this.cc;
                // canvas.height = window.innerWidth * this.cc;
                this.fill_areas();
                this.draw_axises();
                this.draw_points();
            },
            draw_axises: function () {
                let canvas = document.getElementById('canvas');
                let ctx = canvas.getContext('2d');
                let w = canvas.width;
                let h = canvas.height;
                let tickStep = w / 12;
                let tickCoo = tickStep;
                let space = tickStep / 2;
                ctx.strokeStyle = "#585957";
                ctx.fillStyle = "#585957";
                ctx.lineWidth = 1.2;

                // x
                ctx.moveTo(w - space, h / 2);
                ctx.lineTo(space, h / 2);
                ctx.moveTo(w - space, h / 2);
                ctx.lineTo(w - space * 1.2, h / 2 - space / 5);
                ctx.moveTo(w - space, h / 2);
                ctx.lineTo(w - space * 1.2, h / 2 + space / 5);

                //y
                ctx.moveTo(w / 2, space);
                ctx.lineTo(w / 2, h - space);
                ctx.moveTo(w / 2, space);
                ctx.lineTo(w / 2 + space / 5, space * 1.2);
                ctx.moveTo(w / 2, space);
                ctx.lineTo(w / 2 - space / 5, space * 1.2);
                ctx.stroke();

                // ticks and marks
                let tickSize = 8;
                ctx.font = "11px";
                for (let i = -5; i < 6; i++) {
                    if (i === 0) {
                        ctx.fillText(i + "", tickCoo + tickSize, h / 2 + tickSize * 2);
                        tickCoo += tickStep;
                    } else {
                        ctx.fillRect(tickCoo, h / 2 - tickSize / 2, 0.5, tickSize);
                        ctx.fillText(i + "", tickCoo - 1, h / 2 + tickSize * 2);

                        ctx.fillRect(h / 2 - tickSize / 2, tickCoo, tickSize, 0.5);
                        ctx.fillText(i * (-1) + " ", w / 2 - tickSize * 2, tickCoo + 5);
                        tickCoo += tickStep;
                    }

                }
            },
            draw_points: function () {
                let canvas = document.getElementById('canvas');
                let ctx = canvas.getContext('2d');
                let w = canvas.width;
                let h = canvas.height;
                let tickStep = w / 12;
                let results = this.results.slice();
                console.log(results)// достаем точки из стора
                for (let i = 0; i < results.length; i++) {
                    let result = results[i];
                    let x = result.x;
                    let y = result.y;
                    let res = result.isInArea;
                    if (res === true)
                        ctx.fillStyle = "#42cd21";
                    else
                        ctx.fillStyle = "#c60a22";
                    ctx.beginPath();
                    let x_on_canvas = this.get_pos_on_canvas(x, w);
                    let y_on_canvas = this.get_pos_on_canvas(y * (-1), h);
                    ctx.moveTo(x_on_canvas, y_on_canvas);
                    ctx.arc(x_on_canvas, y_on_canvas, 2.5, Math.PI * 2, 0);
                    ctx.fill();
                }
            },
            get_pos_on_canvas: function (coo, par) {
                return (6 + coo) * par / 12;
            },
            fill_areas: function () {
                let canvas = document.getElementById('canvas');
                let ctx = canvas.getContext('2d');
                let w = canvas.width;
                let h = canvas.height;
                let tickStep = w / 12;
                let r = this.r;
                if (r < 0) r = 0;

                ctx.fillStyle = "#9887e2";
                r *= tickStep;

                // quarter circle
                ctx.moveTo(w / 2, h / 2);
                ctx.arc(w / 2, h / 2, r, Math.PI * 1.5, 0);
                ctx.fill();

                // triangle
                // without this it keeps drawing border
                ctx.moveTo(w / 2 - r / 2, h / 2);
                ctx.lineTo(w / 2, h / 2);
                ctx.lineTo(w / 2, h / 2 + r);
                ctx.fill();
                ctx.beginPath();

                // rectangle
                ctx.fillRect(w / 2 - r, h / 2 - r, r, r);
                ctx.closePath();

            },
            redraw: function () {
                let canvas = document.getElementById('canvas');
                let ctx = canvas.getContext('2d');
                let foo = window.innerWidth;
                if (foo > window.innerHeight) foo = window.innerHeight;
                canvas.width = foo / 1.5;
                canvas.height = foo / 1.5;
                let w = canvas.width;
                let h = canvas.height;
                let tickStep = w / 12;
                canvas.width = 1;
                canvas.width = w;
                this.draw_plot();
            },
            getMouseCoords: function (e) {
                let canvas = document.getElementById('canvas');
                let ctx = canvas.getContext('2d');
                let w = canvas.width;
                let h = canvas.height;
                let tickStep = w / 12;
                let rect = canvas.getBoundingClientRect();
                return {
                    x: 6 - (w - (e.clientX - rect.left)) * 12 / w,
                    y: (6 - (h - (e.clientY - rect.top)) * 12 / h) * (-1)
                };
            }
        },
        computed: {
            showResults: function () {
                this.updateCanvas = !this.updateCanvas;
                return this.results.slice().reverse()
            }
        },
        watch:{
            updateCanvas:function () {
                this.redraw();
            }
        },
        mounted() {
            window.onresize = () => {
                // this.windowWidth = window.innerWidth;
                // if (window.innerWidth > 889) {
                //     this.cc = 0.1
                // } else {
                //     this.cc = 0.5
                // }
                this.redraw();
            }
        }
    });

    let app = new Vue({
        el: '#app',
        data: {
            // username: magic_data.username,
            results: magic_data.results
        },

    });

</script>
</body>

</html>